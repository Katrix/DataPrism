<!DOCTYPE html><html data-githubContributorsUrl="https://api.github.com/repos/Katrix/DataPrism" data-githubContributorsFilename="docs/_docs/guide/06_compiled.md" data-pathToRoot=""><head><meta charset="utf-8"></meta><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"></meta><title>Compiled queries and commands</title><link rel="shortcut icon" type="image/x-icon" href="favicon.ico"></link><script type="text/javascript" src="scripts/theme.js"></script><script type="text/javascript" src="scripts/searchData.js" defer="true"></script><script type="text/javascript" src="scripts/scastieConfiguration.js" defer="true"></script><link rel="stylesheet" href="styles/theme/bundle.css"></link><link rel="stylesheet" href="styles/theme/components/bundle.css"></link><link rel="stylesheet" href="styles/theme/components/button/bundle.css"></link><link rel="stylesheet" href="styles/theme/layout/bundle.css"></link><link rel="stylesheet" href="styles/nord-light.css"></link><link rel="stylesheet" href="styles/dotty-icons.css"></link><link rel="stylesheet" href="styles/filter-bar.css"></link><link rel="stylesheet" href="styles/code-snippets.css"></link><link rel="stylesheet" href="styles/searchbar.css"></link><link rel="stylesheet" href="styles/social-links.css"></link><link rel="stylesheet" href="styles/versions-dropdown.css"></link><link rel="stylesheet" href="styles/content-contributors.css"></link><link rel="stylesheet" href="styles/fontawesome.css"></link><script type="text/javascript" src="hljs/highlight.pack.js" defer="true"></script><script type="text/javascript" src="scripts/hljs-scala3.js" defer="true"></script><script type="text/javascript" src="scripts/ux.js" defer="true"></script><script type="text/javascript" src="scripts/common/component.js" defer="true"></script><script type="text/javascript" src="scripts/common/utils.js" defer="true"></script><script type="text/javascript" src="scripts/components/FilterBar.js" defer="true"></script><script type="text/javascript" src="scripts/components/DocumentableList.js" defer="true"></script><script type="text/javascript" src="scripts/components/Input.js" defer="true"></script><script type="text/javascript" src="scripts/components/FilterGroup.js" defer="true"></script><script type="text/javascript" src="scripts/components/Filter.js" defer="true"></script><script type="text/javascript" src="scripts/scaladoc-scalajs.js" defer="true"></script><script type="text/javascript" src="scripts/contributors.js" defer="true"></script><script type="text/javascript" src="https://code.jquery.com/jquery-3.5.1.min.js" defer="true"></script><script type="text/javascript" src="https://d3js.org/d3.v6.min.js" defer="true"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/graphlib-dot@0.6.2/dist/graphlib-dot.min.js" defer="true"></script><script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/dagre-d3/0.6.1/dagre-d3.min.js" defer="true"></script><script type="text/javascript" src="https://scastie.scala-lang.org/embedded.js" defer="true"></script><script type="text/javascript" src="scripts/data.js" defer="true"></script><link rel="stylesheet" href="styles/staticsitestyles.css"></link><script>var pathToRoot = "";</script></head><body><div id=""><div id="header" class="body-small"><div class="header-container-left"><a href="" class="logo-container"><span class="project-name h300">DataPrism</span></a><span onclick="dropdownHandler(event)" class="text-button with-arrow" id="dropdown-trigger"><a><div class="projectVersion">0.0.0+54-3dab9399-SNAPSHOT</div></a></span><div id="version-dropdown" class="dropdown-menu"></div></div><div class="header-container-right"><button id="search-toggle" class="icon-button"></button><span id="theme-toggle" class="icon-button"></span><span id="mobile-menu-toggle" class="icon-button hamburger"></span></div></div><div id="mobile-menu"><div class="mobile-menu-header body-small"><span class="mobile-menu-logo"><span class="project-name h300">DataPrism</span></span><button id="mobile-menu-close" class="icon-button close"></button></div><div class="mobile-menu-container body-medium"><input id="mobile-scaladoc-searchbar-input" class="scaladoc-searchbar-input" type="search" placeholder="Find anything"></input><span id="mobile-theme-toggle" class="mobile-menu-item mode"></span></div></div><span id="mobile-sidebar-toggle" class="floating-button"></span><div id="leftColumn" class="body-small"><div class="switcher-container"><a id="docs-nav-button" class="switcher h100 selected" href="index.html">Docs</a><a id="api-nav-button" class="switcher h100 " href="api/index.html">API</a></div><nav id="docs-nav" class="side-menu"><div class="ni n0 "><span class="nh de"><a href="01_table_definitions.html"><span>Table definitions</span></a></span></div><div class="ni n0 "><span class="nh de"><a href="02_queries.html"><span>Queries</span></a></span></div><div class="ni n0 "><span class="nh de"><a href="03_operations.html"><span>Operations (SELECT, INSERT, UPDATE, DELETE)</span></a></span></div><div class="ni n0 "><span class="nh de"><a href="04_types.html"><span>Types</span></a></span></div><div class="ni n0 "><span class="nh de"><a href="05_dbvalue_expressions.html"><span>DbValue and Expressions</span></a></span></div><div class="ni n0 expanded"><span class="nh h100 selected de"><a href="#"><span>Compiled queries and commands</span></a></span></div><div class="ni n0 "><span class="nh de"><a href="07_mapres_exotic_data.html"><span>MapRes and Exotic data</span></a></span></div><div class="ni n0 "><span class="nh de"><a href="08_transactions.html"><span>Transactions</span></a></span></div><div class="ni n0 "><span class="nh de"><a href="09_cats_effects.html"><span>Usage with Cats effects</span></a></span></div><div class="ni n0 "><span class="nh de"><a href="10_fs2_effects.html"><span>Usage with Fs2</span></a></span></div><div class="ni n0 "><span class="nh de"><a href="11_skunk.html"><span>Usage with Skunk</span></a></span></div></nav></div><div id="footer" class="body-small"><div class="left-container">Generated with</div><div class="right-container"><a href="https://github.com/Katrix/DataPrism"><button class="icon-button gh"></button></a><div class="text"></div></div><div class="text-mobile"></div></div><div id="scaladoc-searchBar"></div><div id="main"><div class="breadcrumbs container"><a href="index.html">DataPrism</a>/<a href="06_compiled.html">Compiled queries and commands</a></div><div id="content" class="body-medium"><div><section id="compiled-queries-and-commands-1"> 
 <h1 class="h500"><a href="#compiled-queries-and-commands-1" class="anchor"></a>Compiled queries and commands</h1> 
 <p>DataPrism can, if desired compile an operation so that it only has to create the SQL for it once, instead of again and again. This generally takes the form of a function accepting types of the arguments to compile, and another function allowing use of those values as <code>DbValue</code>. The two global compile operations are <code>raw</code> and <code>operation</code>. <code>raw</code> works with raw <code>SqlStr</code>s, while <code>operation</code> works with operations like SELECT and DELETE. The docs here will only look at operations If you need raw, you'll know, and hopefully be able to figure out how to use it.</p> 
 <div class="snippet mono-small-block" scala-snippet="" runnable=""> 
  <pre><code class="language-scala"><span line-number="1" class=""><span class="tooltip-container"></span>import dataprism.KMacros
</span><span line-number="2" class=""><span class="tooltip-container"></span>import dataprism.sql.{Table, Column}
</span><span line-number="3" class=""><span class="tooltip-container"></span>import dataprism.jdbc.sql.{JdbcCodec, DataSourceDb}
</span><span line-number="4" class=""><span class="tooltip-container"></span>import dataprism.jdbc.sql.PostgresJdbcTypes.*
</span><span line-number="5" class=""><span class="tooltip-container"></span>import scala.concurrent.Future
</span><span line-number="6" class=""><span class="tooltip-container"></span>
</span><span line-number="7" class=""><span class="tooltip-container"></span>case class UserK[F[_]](
</span><span line-number="8" class=""><span class="tooltip-container"></span>  id: F[Int],
</span><span line-number="9" class=""><span class="tooltip-container"></span>  name: F[Option[String]],
</span><span line-number="10" class=""><span class="tooltip-container"></span>  username: F[String],
</span><span line-number="11" class=""><span class="tooltip-container"></span>  email: F[String]
</span><span line-number="12" class=""><span class="tooltip-container"></span>)
</span><span line-number="13" class=""><span class="tooltip-container"></span>
</span><span line-number="14" class=""><span class="tooltip-container"></span>object UserK:
</span><span line-number="15" class=""><span class="tooltip-container"></span>  // Snippet compiler fails here sadly
</span><span line-number="16" class=""><span class="tooltip-container"></span>  given KMacros.ApplyTraverseKC[UserK] = ??? // KMacros.deriveApplyTraverseKC[UserK]
</span><span line-number="17" class=""><span class="tooltip-container"></span>
</span><span line-number="18" class=""><span class="tooltip-container"></span>  val table: Table[JdbcCodec, UserK] = Table(
</span><span line-number="19" class=""><span class="tooltip-container"></span>    "users",
</span><span line-number="20" class=""><span class="tooltip-container"></span>    UserK(
</span><span line-number="21" class=""><span class="tooltip-container"></span>      Column("id", integer),
</span><span line-number="22" class=""><span class="tooltip-container"></span>      Column("name", text.nullable),
</span><span line-number="23" class=""><span class="tooltip-container"></span>      Column("username", text),
</span><span line-number="24" class=""><span class="tooltip-container"></span>      Column("email", text)
</span><span line-number="25" class=""><span class="tooltip-container"></span>    )
</span><span line-number="26" class=""><span class="tooltip-container"></span>  )
</span><span line-number="27" class=""><span class="tooltip-container"></span>
</span><span line-number="28" class=""><span class="tooltip-container"></span>import scala.concurrent.ExecutionContext.Implicits.global
</span><span line-number="29" class=""><span class="tooltip-container"></span>
</span><span line-number="30" class=""><span class="tooltip-container"></span>given DataSourceDb[Future] = DataSourceDb.ofFuture(???)
</span></code></pre> 
  <div class="snippet-meta"> 
   <div class="snippet-label">
     Setup.scala 
   </div> 
  </div> 
  <div class="buttons"></div> 
 </div> 
</section> 
<section id="operation-1"> 
 <h2 class="h500"><a href="#operation-1" class="anchor"></a>operation</h2> 
 <p>Here are two examples of how operation works. Due to Scala inferring too precise of a type for the <code>Type</code> arguments, the code calls <code>forgetNNA</code> on the types.</p> 
 <div class="snippet mono-small-block" scala-snippet="" runnable=""> 
  <pre><code class="language-scala"><span line-number="1" class="hideable include"><span class="tooltip-container"></span>import dataprism.KMacros
</span><span line-number="2" class="hideable include"><span class="tooltip-container"></span>import dataprism.sql.{Table, Column}
</span><span line-number="3" class="hideable include"><span class="tooltip-container"></span>import dataprism.jdbc.sql.{JdbcCodec, DataSourceDb}
</span><span line-number="4" class="hideable include"><span class="tooltip-container"></span>import dataprism.jdbc.sql.PostgresJdbcTypes.*
</span><span line-number="5" class="hideable include"><span class="tooltip-container"></span>import scala.concurrent.Future
</span><span line-number="6" class="hideable include"><span class="tooltip-container"></span>
</span><span line-number="7" class="hideable include"><span class="tooltip-container"></span>case class UserK[F[_]](
</span><span line-number="8" class="hideable include"><span class="tooltip-container"></span>  id: F[Int],
</span><span line-number="9" class="hideable include"><span class="tooltip-container"></span>  name: F[Option[String]],
</span><span line-number="10" class="hideable include"><span class="tooltip-container"></span>  username: F[String],
</span><span line-number="11" class="hideable include"><span class="tooltip-container"></span>  email: F[String]
</span><span line-number="12" class="hideable include"><span class="tooltip-container"></span>)
</span><span line-number="13" class="hideable include"><span class="tooltip-container"></span>
</span><span line-number="14" class="hideable include"><span class="tooltip-container"></span>object UserK:
</span><span line-number="15" class="hideable include"><span class="tooltip-container"></span>  // Snippet compiler fails here sadly
</span><span line-number="16" class="hideable include"><span class="tooltip-container"></span>  given KMacros.ApplyTraverseKC[UserK] = ??? // KMacros.deriveApplyTraverseKC[UserK]
</span><span line-number="17" class="hideable include"><span class="tooltip-container"></span>
</span><span line-number="18" class="hideable include"><span class="tooltip-container"></span>  val table: Table[JdbcCodec, UserK] = Table(
</span><span line-number="19" class="hideable include"><span class="tooltip-container"></span>    "users",
</span><span line-number="20" class="hideable include"><span class="tooltip-container"></span>    UserK(
</span><span line-number="21" class="hideable include"><span class="tooltip-container"></span>      Column("id", integer),
</span><span line-number="22" class="hideable include"><span class="tooltip-container"></span>      Column("name", text.nullable),
</span><span line-number="23" class="hideable include"><span class="tooltip-container"></span>      Column("username", text),
</span><span line-number="24" class="hideable include"><span class="tooltip-container"></span>      Column("email", text)
</span><span line-number="25" class="hideable include"><span class="tooltip-container"></span>    )
</span><span line-number="26" class="hideable include"><span class="tooltip-container"></span>  )
</span><span line-number="27" class="hideable include"><span class="tooltip-container"></span>
</span><span line-number="28" class="hideable include"><span class="tooltip-container"></span>import scala.concurrent.ExecutionContext.Implicits.global
</span><span line-number="29" class="hideable include"><span class="tooltip-container"></span>
</span><span line-number="30" class="hideable include"><span class="tooltip-container"></span>given DataSourceDb[Future] = DataSourceDb.ofFuture(???)
</span><span line-number="31" class="hideable include"><span class="tooltip-container"></span>
</span><span line-number="32" class=""><span class="tooltip-container"></span>import dataprism.jdbc.platform.PostgresJdbcPlatform.Api.*
</span><span line-number="33" class=""><span class="tooltip-container"></span>import perspective.Id
</span><span line-number="34" class=""><span class="tooltip-container"></span>import scala.concurrent.Future
</span><span line-number="35" class=""><span class="tooltip-container"></span>
</span><span line-number="36" class=""><span class="tooltip-container"></span>val f1: String =&gt; Future[Seq[UserK[Id]]] =
</span><span line-number="37" class=""><span class="tooltip-container"></span>  Compile.operation(text.forgetNNA) { (textValue: DbValue[String]) =&gt;
</span><span line-number="38" class=""><span class="tooltip-container"></span>    Select(Query.from(UserK.table).filter(_.username === textValue))
</span><span line-number="39" class=""><span class="tooltip-container"></span>  }
</span><span line-number="40" class=""><span class="tooltip-container"></span>
</span><span line-number="41" class=""><span class="tooltip-container"></span>val f2: ((String, String)) =&gt; Future[Seq[UserK[Id]]] =
</span><span line-number="42" class=""><span class="tooltip-container"></span>  Compile.operation((text.forgetNNA, text.forgetNNA)) {
</span><span line-number="43" class=""><span class="tooltip-container"></span>    (textValue1: DbValue[String], textValue2: DbValue[String]) =&gt;
</span><span line-number="44" class=""><span class="tooltip-container"></span>      Select(
</span><span line-number="45" class=""><span class="tooltip-container"></span>        Query.from(UserK.table).filter { u =&gt;
</span><span line-number="46" class=""><span class="tooltip-container"></span>          u.username === textValue1 &amp;&amp; u.email === textValue2
</span><span line-number="47" class=""><span class="tooltip-container"></span>        }
</span><span line-number="48" class=""><span class="tooltip-container"></span>      )
</span><span line-number="49" class=""><span class="tooltip-container"></span>  }
</span></code></pre> 
  <div class="buttons"></div> 
 </div> 
</section></div><div id="toc" class="body-small"><div id="toc-container"><span class="toc-title h200">In this article</span><nav class="toc-nav"><ul class="toc-list"><li><a href="#compiled-queries-and-commands-1">Compiled queries and commands</a><ul><li><a href="#operation-1">operation</a></li></ul></li></ul></nav></div></div></div><div id="footer" class="body-small mobile-footer"><div class="left-container">Generated with</div><div class="right-container"><a href="https://github.com/lampepfl/dotty"><button class="icon-button gh"></button></a><a href="https://twitter.com/scala_lang"><button class="icon-button twitter"></button></a><a href="https://discord.com/invite/scala"><button class="icon-button discord"></button></a><a href="https://gitter.im/scala/scala"><button class="icon-button gitter"></button></a><div class="text"></div></div><div class="text-mobile"></div></div></div></div></body></html>